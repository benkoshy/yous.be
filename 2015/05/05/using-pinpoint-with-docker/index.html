<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Using Pinpoint with Docker</title><meta name="description" content="How to use Pinpoint with Docker."><meta name="keywords" content="pinpoint, docker"><link rel="stylesheet" href="/css/main.css"><link rel="canonical" href="https://yous.be/2015/05/05/using-pinpoint-with-docker/"><link rel="alternate" type="application/rss+xml" title="Yous" href="/atom.xml"><link href="/favicon.png" rel="icon"><link href="/apple-touch-icon.png" rel="apple-touch-icon"><link href="/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76"><link href="/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120"><link href="/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152"><link href="/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180"><meta property="fb:admins" content="100001802412550"><meta property="og:title" content="Using Pinpoint with Docker"><meta property="og:site_name" content="Yous"><meta property="og:url" content="https://yous.be/2015/05/05/using-pinpoint-with-docker/"><meta property="og:description" content="How to use Pinpoint with Docker."><meta property="og:image" content="http://yous.be/images/2015/05/05/logo.png"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Using Pinpoint with Docker"><meta name="twitter:description" content="How to use Pinpoint with Docker."><meta name="twitter:image:src" content="http://yous.be/images/2015/05/05/logo.png"> <script type="text/javascript"> WebFontConfig = { google: { families: [ 'Bitter:400,700,400italic:latin' ] } }; (function() { var wf = document.createElement('script'); wf.src = ('https:' == document.location.protocol ? 'https' : 'http') + '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js'; wf.type = 'text/javascript'; wf.async = 'true'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(wf, s); })(); </script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-43111808-1', 'auto'); ga('send', 'pageview'); </script><body><header class="site-header" role="banner"><div class="wrapper"> <a class="site-title" href="/">Yous</a><nav class="site-nav"> <a class="page-link" href="/about/">About</a> <a class="page-link" href="/archives/">Archives</a></nav></div></header><main class="page-content" aria-label="Content"><div class="wrapper"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header class="post-header"><h1 class="post-title" itemprop="name headline">Using Pinpoint with Docker</h1><p class="post-meta"><time datetime="2015-05-05T03:12:07+00:00" itemprop="datePublished">May 5, 2015</time> • <a href="/categories/technology/">Technology</a></header><div class="post-content" itemprop="articleBody"><p><img src="/images/2015/05/05/logo.png" alt="Pinpoint" title="Pinpoint" /><blockquote><p><a href="https://github.com/naver/pinpoint"><strong>Pinpoint</strong></a> is an open source APM (Application Performance Management) tool for large-scale distributed systems written in Java.</blockquote><h2>Preliminary</h2><p>In this post, our goal is to run a sample Pinpoint instance with QuickStart scripts. You can find them on <a href="https://github.com/naver/pinpoint/tree/master/quickstart">GitHub</a>. Also note that we’re going to use <a href="https://www.docker.com/">Docker</a>.<h2>Requirements</h2><p>First things first, install Docker.<div class="language-sh highlighter-rouge"><pre class="highlight"><code>wget -qO- https://get.docker.com/ | sh
</code></pre></div><p>You can verify <code class="highlighter-rouge">docker</code> is installed correctly.<div class="language-sh highlighter-rouge"><pre class="highlight"><code>sudo docker run hello-world
</code></pre></div><p>For more details, see the <a href="https://docs.docker.com/installation/#installation">installation guides</a> of Docker.<h2>Look into the Dockerfile</h2><p>In fact, I already made a Dockerfile for Pinpoint. You can see on <a href="https://github.com/yous/pinpoint-docker">yous/pinpoint-docker</a>. From now on, I’ll describe the Dockerfile line by line.<pre><code class="language-dockerfile">FROM debian
</code></pre><p><a href="https://docs.docker.com/reference/builder/#from"><code class="highlighter-rouge">FROM</code></a> instruction sets the base image of the Docker. We use lateste debian image.<pre><code class="language-dockerfile">RUN echo 'deb http://http.debian.net/debian/ wheezy contrib' &gt;&gt; /etc/apt/sources.list
RUN apt-get update
</code></pre><p><a href="https://docs.docker.com/reference/builder/#run"><code class="highlighter-rouge">RUN</code></a> instruction executes commands in Docker. We add <code class="highlighter-rouge">http://http.debian.net/debian/ wheezy contrib</code> to the <code class="highlighter-rouge">/etc/apt/sources.list</code> for <code class="highlighter-rouge">java-package</code> package, and then run <code class="highlighter-rouge">apt-get update</code>.<pre><code class="language-dockerfile">RUN DEBIAN_FRONTEND=noninteractive apt-get install -y git wget curl procps net-tools
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y java-package fakeroot
</code></pre><p>In this section, we install basic tools like <code class="highlighter-rouge">git</code>, <code class="highlighter-rouge">wget</code>, <code class="highlighter-rouge">curl</code>. Also <code class="highlighter-rouge">procps</code> contains <code class="highlighter-rouge">ps</code>, <code class="highlighter-rouge">net-tools</code> contains <code class="highlighter-rouge">netstat</code> which is used by QuickStart scripts later.<p>Note the <code class="highlighter-rouge">DEBIAN_FRONTEND=noninteractive</code>, this is only for the <code class="highlighter-rouge">apt-get install</code> while building a Docker image, and this suppresses warning messages of <code class="highlighter-rouge">apt-get install</code>. Also we can set <code class="highlighter-rouge">DEBIAN_FRONTEND</code> with:<pre><code class="language-dockerfile">ENV DEBIAN_FRONTEND noninteractive
</code></pre><p>But we won’t add this line because when <code class="highlighter-rouge">ENV</code> sets, it will remain even after it finished the build. This is bad when we run the Docker image by <code class="highlighter-rouge">docker run -i -t ... bash</code>, the Docker is interactive, but the <code class="highlighter-rouge">DEBIAN_FRONTEND</code> is set wrong. So we’ll only set it inline. You can see the information on <a href="https://github.com/docker/docker/issues/4032">docker/docker#4032</a>.<pre><code class="language-dockerfile">RUN useradd pinpoint -m
</code></pre><p>As <a href="https://github.com/naver/pinpoint/blob/master/doc/installation.md">installation guide of Pinpoint</a> indicates, we need to install JDK 6 and JDK 7+. To install Java, we need a non-root user. So we add a user <code class="highlighter-rouge">pinpoint</code> and create its home directory by passing <code class="highlighter-rouge">-m</code>. Adding a user is needed to install Java.<pre><code class="language-dockerfile">WORKDIR /home/pinpoint
</code></pre><p><a href="https://docs.docker.com/reference/builder/#workdir"><code class="highlighter-rouge">WORKDIR</code></a> instruction sets the working directory for Docker. After this line, any <code class="highlighter-rouge">RUN</code> instructions are runned in this working directory.<pre><code class="language-dockerfile">RUN wget --no-cookies --header "Cookie: oraclelicense=accept-securebackup-cookie" \
  http://download.oracle.com/otn-pub/java/jdk/6u45-b06/jdk-6u45-linux-x64.bin
RUN chown pinpoint jdk-6u45-linux-x64.bin
RUN su pinpoint -c 'yes | fakeroot make-jpkg jdk-6u45-linux-x64.bin'
RUN rm jdk-6u45-linux-x64.bin
RUN dpkg -i oracle-j2sdk1.6_1.6.0+update45_amd64.deb
RUN rm oracle-j2sdk1.6_1.6.0+update45_amd64.deb

RUN wget --no-cookies --header "Cookie: oraclelicense=accept-securebackup-cookie" \
  http://download.oracle.com/otn-pub/java/jdk/7u79-b15/jdk-7u79-linux-x64.tar.gz
RUN chown pinpoint jdk-7u79-linux-x64.tar.gz
RUN su pinpoint -c 'yes | fakeroot make-jpkg jdk-7u79-linux-x64.tar.gz'
RUN rm jdk-7u79-linux-x64.tar.gz
RUN dpkg -i oracle-j2sdk1.7_1.7.0+update79_amd64.deb
RUN rm oracle-j2sdk1.7_1.7.0+update79_amd64.deb
</code></pre><p>Now we install Java SE 6 and then Java SE 7 on the Docker. The <code class="highlighter-rouge">wget</code> script is from <a href="http://stackoverflow.com/a/10959815/3108885">“How to automate download and installation of Java JDK on Linux?”</a>. Running <code class="highlighter-rouge">fakeroot make-jpkg ...</code> and <code class="highlighter-rouge">dpkg -i ...</code> installs Java.<pre><code class="language-dockerfile">ENV JAVA_6_HOME /usr/lib/jvm/j2sdk1.6-oracle
ENV JAVA_7_HOME /usr/lib/jvm/j2sdk1.7-oracle
ENV JAVA_HOME /usr/lib/jvm/j2sdk1.7-oracle
</code></pre><p>For the requirements of Pinpoint, we set <code class="highlighter-rouge">JAVA_6_HOME</code>, <code class="highlighter-rouge">JAVA_7_HOME</code> and <code class="highlighter-rouge">JAVA_HOME</code> environment variables.<pre><code class="language-dockerfile">WORKDIR /usr/local/apache-maven
</code></pre><p>Now we’re going to install Maven.<pre><code class="language-dockerfile">ADD http://mirror.apache-kr.org/maven/maven-3/3.2.5/binaries/apache-maven-3.2.5-bin.tar.gz ./
ADD http://www.apache.org/dist//maven/maven-3/3.2.5/binaries/apache-maven-3.2.5-bin.tar.gz.md5 ./
ADD http://www.apache.org/dist//maven/maven-3/3.2.5/binaries/apache-maven-3.2.5-bin.tar.gz.asc ./
</code></pre><p><a href="https://docs.docker.com/reference/builder/#add"><code class="highlighter-rouge">ADD</code></a> instructions copies new files, directories, or remote file from URL to the specified path. Above lines just download Maven files from Apache mirror.<pre><code class="language-dockerfile">RUN [ $(md5sum apache-maven-3.2.5-bin.tar.gz | grep --only-matching -m 1 '^[0-9a-f]*') = $(cat apache-maven-3.2.5-bin.tar.gz.md5) ]
</code></pre><p>This matches MD5 hash checksum of <code class="highlighter-rouge">apache-maven-3.2.5-bin.tar.gz</code> with <code class="highlighter-rouge">apache-maven-3.2.5-bin-tar.gz.md5</code>.<pre><code class="language-dockerfile">RUN gpg --keyserver pgp.mit.edu --recv-key BB617866
RUN gpg --verify apache-maven-3.2.5-bin.tar.gz.asc apache-maven-3.2.5-bin.tar.gz
</code></pre><p>This verifies signature for <code class="highlighter-rouge">apache-maven-3.2.5-bin.tar.gz</code> with <code class="highlighter-rouge">apache-maven-3.2.5-bin.tar.gz.asc</code>.<pre><code class="language-dockerfile">RUN tar -xf apache-maven-3.2.5-bin.tar.gz
ENV PATH $PATH:/usr/local/apache-maven/apache-maven-3.2.5/bin
RUN rm apache-maven-3.2.5-bin.tar.gz apache-maven-3.2.5-bin.tar.gz.md5 apache-maven-3.2.5-bin.tar.gz.asc
</code></pre><p>Now we install Maven 3.2.5 on the Docker. Note that we have to add the path of Maven to the <code class="highlighter-rouge">PATH</code>.<pre><code class="language-dockerfile">RUN git clone https://github.com/naver/pinpoint.git /pinpoint
WORKDIR /pinpoint
RUN mvn install -Dmaven.test.skip=true
</code></pre><p>All requirements are installed, so we clone Pinpoint to the <code class="highlighter-rouge">/pinpoint</code> and install it.<pre><code class="language-dockerfile">WORKDIR quickstart/hbase
ADD http://archive.apache.org/dist/hbase/hbase-0.94.25/hbase-0.94.25.tar.gz ./
RUN tar -xf hbase-0.94.25.tar.gz
RUN rm hbase-0.94.25.tar.gz
RUN ln -s hbase-0.94.25 hbase
RUN cp ../conf/hbase/hbase-site.xml hbase-0.94.25/conf/
RUN chmod +x hbase-0.94.25/bin/start-hbase.sh
</code></pre><p>After installation of Pinpoint, we install HBase 0.94.25 as <a href="https://github.com/naver/pinpoint/blob/master/quickstart/bin/start-hbase.sh"><code class="highlighter-rouge">quickstart/bin/start-hbase.sh</code></a> of Pinpoint does it.<h2>Running Docker</h2><p>You can pull the Docker image:<div class="language-sh highlighter-rouge"><pre class="highlight"><code>docker pull yous/pinpoint
</code></pre></div><p>Then run the image:<div class="language-sh highlighter-rouge"><pre class="highlight"><code>docker run -i -t yous/pinpoint bash
</code></pre></div><p>Also if you want to remove the container after Docker exits, use:<div class="language-sh highlighter-rouge"><pre class="highlight"><code>docker run -i -t --rm yous/pinpoint bash
</code></pre></div><p>This makes you can check some requirements like <code class="highlighter-rouge">which java</code>, but you can’t run QuickStart scripts successfully. Since the scripts check the program name in the result of <code class="highlighter-rouge">netstat</code>, we should pass some option. See <a href="https://github.com/docker/docker/issues/7276">docker/docker#7276</a> for details.<div class="language-sh highlighter-rouge"><pre class="highlight"><code>docker run -i -t --cap-add SYS_PTRACE yous/pinpoint bash
</code></pre></div><p>Also, note that we are going to use port 28080, 28081 and 28082 in QuickStart. So binding a container’s port to a specific port is needed. <code class="highlighter-rouge">-p</code> flag will do it. See <a href="https://docs.docker.com/userguide/dockerlinks/">Linking Containers Together</a> for details.<div class="language-sh highlighter-rouge"><pre class="highlight"><code>docker run -i -t -p 28080:28080 -p 28081:28081 -p 28082:28082 <span class="se">\</span>
  --cap-add SYS_PTRACE yous/pinpoint bash
</code></pre></div><h2>QuickStart</h2><p>We built a Docker image for Pinpoint, so now we can run QuickStart scripts. As mentioned in <a href="https://github.com/naver/pinpoint/blob/master/quickstart/README.md">QuickStart</a> of Pinpoint, we run several scripts.<h3>Install &amp; Start HBase</h3><ul><li>Download &amp; Start: <code class="highlighter-rouge">quickstart/bin/start-hbase.sh</code><li>Initialize Tables: <code class="highlighter-rouge">quickstart/bin/init-hbase.sh</code></ul><h3>Start Pinpoint Daemons</h3><ul><li><p>Collector: <code class="highlighter-rouge">quickstart/bin/start-collector.sh</code><p><img src="/images/2015/05/05/quickstart-start-collector.png" alt="start-collector.sh" title="start-collector.sh" /><li><p>Web UI: <code class="highlighter-rouge">quickstart/bin/start-web.sh</code><p><img src="/images/2015/05/05/quickstart-start-web.png" alt="start-web.sh" title="start-web.sh" /><li><p>TestApp: <code class="highlighter-rouge">quickstart/bin/start-testapp.sh</code><p><img src="/images/2015/05/05/quickstart-start-testapp.png" alt="start-testapp.sh" title="start-testapp.sh" /></ul><p>Once HBase and the 3 daemons are running, visit the following addresses to test out your Pinpoint instance.<ul><li><p>Web UI: <a href="http://localhost:28080">http://localhost:28080</a><p><img src="/images/2015/05/05/quickstart-web-ui.png" alt="Web UI" title="Web UI" /><li><p>TestApp: <a href="http://localhost:28081">http://localhost:28081</a><p><img src="/images/2015/05/05/quickstart-testapp.png" alt="TestApp" title="TestApp" /></ul><h3>Stopping</h3><ul><li>HBase: <code class="highlighter-rouge">quickstart/bin/stop-hbase.sh</code><li>Collector: <code class="highlighter-rouge">quickstart/bin/stop-collector.sh</code><li>Web UI: <code class="highlighter-rouge">quickstart/bin/stop-web.sh</code><li>TestApp: <code class="highlighter-rouge">quickstart/bin/stop-testapp.sh</code></ul><h2>Summary</h2><p>You can run Pinpoint on Docker by:<div class="language-sh highlighter-rouge"><pre class="highlight"><code>docker pull yous/pinpoint
docker run -i -t -p 28080:28080 -p 28081:28081 -p 28082:28082 <span class="se">\</span>
  --cap-add SYS_PTRACE yous/pinpoint bash
</code></pre></div><p>Inside the Docker, run:<div class="language-sh highlighter-rouge"><pre class="highlight"><code>quickstart/bin/start-hbase.sh
quickstart/bin/init-hbase.sh
quickstart/bin/start-collector.sh
quickstart/bin/start-web.sh
quickstart/bin/start-testapp.sh
</code></pre></div><p>Then you can access <a href="http://localhost:28080">http://localhost:28080</a> for Web UI and <a href="http://localhost:28081">http://localhost:28081</a> for TestApp.<p>Note again, you can see my Dockerfile on <a href="https://github.com/yous/pinpoint-docker">yous/pinpoint-docker</a>. Any issues and pull requests are welcome!</div></article></div></main><footer class="site-footer"><div class="wrapper"><p> Content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a><br /> &copy; 2013&ndash;2017 - <a href="/about/">Yous</a> - <a href="/atom.xml">RSS</a></div></footer>
