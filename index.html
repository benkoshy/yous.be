<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Yous</title><meta name="description" content="Blog for hackers."><link rel="stylesheet" href="/assets/main.css"><link rel="canonical" href="https://yous.be/"><link rel="alternate" type="application/rss+xml" title="Yous" href="https://yous.be/atom.xml"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" href="/icon-192x192.png"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="mask-icon" color="#2568ba" href="/safari-pinned-tab.svg"><meta name="msapplication-TileColor" content="#2568ba"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta property="fb:admins" content="100001802412550"><meta property="og:title" content="Yous"><meta property="og:site_name" content="Yous"><meta property="og:url" content="https://yous.be/"><meta property="og:description" content="Blog for hackers."><meta property="og:image" content="http://yous.be/images/about/yous.png"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Yous"><meta name="twitter:description" content="Blog for hackers."><meta name="twitter:image:src" content="http://yous.be/images/about/yous.png"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700&display=swap" rel="stylesheet"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-43111808-1', 'auto'); ga('send', 'pageview'); </script><body><header class="site-header"><div class="wrapper"> <a class="site-title" href="/">Yous</a><nav class="site-nav"> <a class="page-link" href="/about/">About</a> <a class="page-link" href="/archives/">Archives</a></nav></div></header><main class="page-content" aria-label="Content"><div class="wrapper"><div class="home"><ul class="post-list"><li><header class="post-header"><h1 class="post-title"> <a class="post-link" href="/2019/01/15/integrate-homebrew-ruby-with-chruby/">Integrate Homebrew Ruby with chruby</a></h1><p class="post-meta"> Jan 15, 2019 • <a href="/categories/ruby/">Ruby</a></p></header><div class="post-content"><p>For a while after <a href="/2016/01/01/switching-rvm-to-chruby/">switching from RVM to chruby</a>, I’ve been quite satisfied with <a href="https://github.com/postmodern/chruby">chruby</a>, except for one thing. Every time Ruby releases a new version, I had to compile that version from scratch using <a href="https://github.com/postmodern/ruby-install">ruby-install</a>. It takes quite a long time, and I should do that on every macOS device I use.</p><p><a href="http://xkcd.com/303/"><img src="/images/2019/01/15/compiling.png" alt="Compiling" title="'Are you stealing those LCDs?' 'Yeah, but I'm doing it while my code compiles.'" /></a></p><h2>Why should I compile?</h2><p>I wanted to install pre-compiled Ruby. It should exist! Then I thought up Homebrew. Almost every formula of Homebrew has “bottles” for multiple versions of macOS. So I thought: ‘Just use Homebrew Ruby with chruby!’</p><h2>Cleaning up</h2><p>Homebrew Ruby is <a href="https://github.com/Homebrew/homebrew-core/commit/b4bf45228a60a9a64a0f17d0374b27ffe84c862c">keg-only</a> since 2.5.3, so if you had installed Homebrew Ruby earlier than or equal to 2.5.3, make sure to unlink it. Binaries of gems were placed under <code class="highlighter-rouge">/usr/local/bin/</code>, so they can make problems related to PATH.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">unlink </span>ruby
</code></pre></div></div><h2>Integrating Homebrew Ruby with ruby-install</h2><p>By default, ruby-install installs Rubies into <code class="highlighter-rouge">~/.rubies</code>. If you install Ruby 2.6.0 using <code class="highlighter-rouge">ruby-install ruby 2.6.0</code>, then the Ruby goes to <code class="highlighter-rouge">~/.rubies/ruby-2.6.0</code>. So what if we make a symbolic link under <code class="highlighter-rouge">~/.rubies</code> pointing Homebrew Ruby?</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ln</span> <span class="nt">-s</span> <span class="s2">"</span><span class="si">$(</span>brew <span class="nt">--prefix</span><span class="si">)</span><span class="s2">/Cellar/ruby/2.6.0"</span> ~/.rubies/ruby-2.6.0
</code></pre></div></div><p>Specify <code class="highlighter-rouge">ruby-2.6.0</code> in <code class="highlighter-rouge">~/.ruby-version</code>, and opening a new shell works like a charm!</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>chruby
 <span class="k">*</span> ruby-2.6.0
</code></pre></div></div><h2>Default gems</h2><p>Although chruby sets <code class="highlighter-rouge">$GEM_HOME</code> and <code class="highlighter-rouge">$GEM_PATH</code> properly, Homebrew intentionally removes binaries of bundled gems on installation, so you have to install them using <code class="highlighter-rouge">gem install</code>.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gem <span class="nb">install </span>bundler
gem <span class="nb">install </span>irb
</code></pre></div></div><h2>Updating Ruby</h2><p>Not only when a new Ruby is released, but also Homebrew sometimes updates Ruby for a new revision. The symlink is based on the cellar, so the link should be updated.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ln</span> <span class="nt">-sfn</span> <span class="s2">"</span><span class="si">$(</span>brew <span class="nt">--prefix</span><span class="si">)</span><span class="s2">/Cellar/ruby/2.6.0_1"</span> ~/.rubies/ruby-2.6.0
</code></pre></div></div><p>No more compiling time!</p></div><li><header class="post-header"><h1 class="post-title"> <a class="post-link" href="/2018/12/02/how-to-open-binary-plist-files-using-vim-plist/">How to open binary plist files using vim-plist</a></h1><p class="post-meta"> Dec 2, 2018 • <a href="/categories/vim/">Vim</a></p></header><div class="post-content"><p><img src="/images/2018/12/02/plist.min.png" alt="Vim editing a binary plist file" title="Vim editing a binary plist file" /></p><p>Using macOS, you may have had experiences of handling plist files. For example, <code class="highlighter-rouge">~/Library/Preferences/.GlobalPreferences.plist</code> file holds some configurations of macOS. When you type <code class="highlighter-rouge">defaults write -g ApplePressAndHoldEnabled -bool false</code> on terminal, the following lines are added to <code class="highlighter-rouge">.GlobalPreferences.plist</code>:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;key&gt;</span>ApplePressAndHoldEnabled<span class="nt">&lt;/key&gt;</span>
<span class="nt">&lt;false/&gt;</span>
</code></pre></div></div><p>So when you dig down the preferences or resources of macOS system, you’ll meet plist files.</p><h2>vim-plist</h2><p>darfink’s <a href="https://github.com/darfink/vim-plist">vim-plist</a> plugin handles *.plist files quite well. A plist file is in one of three formats; json, binary, xml. macOS is bundled with the <code class="highlighter-rouge">plutil</code> command that can convert a plist file from one format to another. The plugin also uses <code class="highlighter-rouge">plutil</code> to handle read and write of plist files.</p><p>The plugin registers autocmd for <a href="https://github.com/darfink/vim-plist/blob/67280fb32b88ad75e255068dfe69b9f069421618/plugin/plist.vim#L19-L20"><code class="highlighter-rouge">BufReadCmd</code> and <code class="highlighter-rouge">FileReadCmd</code></a> to read *.plist files, <a href="https://github.com/darfink/vim-plist/blob/67280fb32b88ad75e255068dfe69b9f069421618/plugin/plist.vim#L16"><code class="highlighter-rouge">BufWriteCmd</code> and <code class="highlighter-rouge">FileWriteCmd</code></a> to write *.plist files. <code class="highlighter-rouge">BufRead</code> and <code class="highlighter-rouge">BufWrite</code> events are triggered <em>after</em> reading the file into the buffer, but <code class="highlighter-rouge">BufReadCmd</code> and <code class="highlighter-rouge">BufWriteCmd</code> events are triggered <em>before</em> reading the file, and that autocmd should handle actual read and write operation of that file. These differences make handling plist files more complex.</p><h2>Problems</h2><h3>*.strings files</h3><p>Overall, the plugin is quite useful and seamless. But recently, I found some *.strings plist files under <code class="highlighter-rouge">/System/Library</code>, almost of them in binary formats. The plugin registers autocmds only for *.plist files, so there is no chance to convert them to readable formats.</p><p>At first, I’ve considered to register an autocmd for *.strings file, but I’m not sure about that <code class="highlighter-rouge">.strings</code> extension is only used for plist file, and also there can be other extensions with plist contents (for example, *.nib files are plist, too).</p><h3>Saving a new file</h3><p>darfink’s vim-plist checks <code class="highlighter-rouge">g:plist_save_format</code> and <code class="highlighter-rouge">b:plist_save_format</code> before writing to plist files. The buffer-local variable is set when the plugin reads the file and detect the format. The global one is set by user, and overrides buffer-local one.</p><p>I don’t want the plugin to override the content of plist files with different format, so I haven’t set <code class="highlighter-rouge">g:plist_save_format</code>. Then the problem raised. Open a new plist file, like <code class="highlighter-rouge">vim test.plist</code>, and save it after editing. Then the plugin didn’t set <code class="highlighter-rouge">b:plist_save_format</code> because it’s a new file, and I also didn’t set <code class="highlighter-rouge">g:plist_save_format</code>, so the plugin don’t know the format to use for saving.</p><p>I think this problem can be solved by patching the plugin, but its last commit is pushed in 2014, which makes me use the faster way.</p><h3>Incomplete plist files (Update: 2019-06-18)</h3><p>vim-plist always uses <code class="highlighter-rouge">plutil -convert</code> command when opening plist files. But <code class="highlighter-rouge">plutil</code> checks whether the given file is valid or not. This leads to a problem when we have incomplete plist files. Say a plist file is tracked by git, and when there is a merge conflict, that plist file will contain SCM conflict markers.</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span>
<span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
<span class="nt">&lt;dict&gt;</span>
<span class="err">&lt;&lt;&lt;&lt;&lt;&lt;</span><span class="nt">&lt; HEAD</span>
    <span class="err">&lt;key</span><span class="nt">&gt;</span>other_content<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;integer&gt;</span>4<span class="nt">&lt;/integer&gt;</span>
=======
    <span class="nt">&lt;key&gt;</span>content<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;integer&gt;</span>5<span class="nt">&lt;/integer&gt;</span>
&gt;&gt;&gt;&gt;&gt;&gt;&gt; master
    <span class="nt">&lt;key&gt;</span>test<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;integer&gt;</span>3<span class="nt">&lt;/integer&gt;</span>
<span class="nt">&lt;/dict&gt;</span>
<span class="nt">&lt;/plist&gt;</span>
</code></pre></div></div><p>With vim-plist, we will never be able to edit this file because vim-plist will refuse to load it into the buffer.</p><h2>Solving the problems with .vimrc</h2><h3>Binary plist files</h3><p>I decided to check if the file is binary plist file or not, and load with functions of vim-plist plugin. The checking process is easy, because the file starts with <code class="highlighter-rouge">bplist</code>. At first, I think it’s okay to register an autocmd for <code class="highlighter-rouge">BufReadCmd</code> because calling functions of the plugin should be easy. So my first try was:</p><div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span><span class="p">!</span> <span class="nv">s:DetectBinaryPlist</span><span class="p">()</span>
  <span class="k">let</span> <span class="k">l</span><span class="p">:</span>filename <span class="p">=</span> expand<span class="p">(</span><span class="s1">'&lt;afile&gt;'</span><span class="p">)</span>
  <span class="k">if</span> filereadable<span class="p">(</span><span class="k">l</span><span class="p">:</span>filename<span class="p">)</span>
    <span class="k">let</span> <span class="k">l</span><span class="p">:</span>content <span class="p">=</span> readfile<span class="p">(</span><span class="k">l</span><span class="p">:</span>filename<span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
    <span class="k">if</span> len<span class="p">(</span>content<span class="p">)</span> <span class="p">&gt;</span> <span class="m">0</span> &amp;&amp; content<span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=~</span># <span class="s1">'^bplist'</span>
      <span class="k">return</span> <span class="m">1</span>
    <span class="k">endif</span>
  <span class="k">endif</span>
  <span class="k">return</span> <span class="m">0</span>
<span class="k">endfunction</span>
autocmd <span class="nb">BufReadCmd</span> *
<span class="se">      \</span> <span class="k">if</span> <span class="nv">s:DetectBinaryPlist</span><span class="p">()</span> <span class="p">|</span>
<span class="se">      \</span>   <span class="k">call</span> plist#Read<span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="p">|</span>
<span class="se">      \</span>   <span class="k">call</span> plist#ReadPost<span class="p">()</span> <span class="p">|</span>
<span class="se">      \</span> <span class="k">endif</span>
</code></pre></div></div><p>Can you see the problem? This makes Vim returns an empty buffer when it reads a file that’s not a binary plist file. As I said above, <code class="highlighter-rouge">BufReadCmd</code> should handle actual read and write operation of the file. If it’s not a binary plist file, Vim won’t read anything according to this code.</p><p>So I changed <code class="highlighter-rouge">BufReadCmd</code> to <code class="highlighter-rouge">BufRead</code>. This event happens <em>after</em> reading the file into the buffer, so I have to empty the buffer.</p><div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span><span class="p">!</span> <span class="nv">s:ConvertBinaryPlist</span><span class="p">()</span>
  <span class="k">silent</span><span class="p">!</span> execute <span class="s1">'%d'</span>
  <span class="k">call</span> plist#Read<span class="p">(</span><span class="m">1</span><span class="p">)</span>
  <span class="k">call</span> plist#ReadPost<span class="p">()</span>
<span class="k">endfunction</span>
autocmd <span class="nb">BufRead</span> *
<span class="se">      \</span> <span class="k">if</span> getline<span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="p">=~</span># <span class="s1">'^bplist'</span> <span class="p">|</span>
<span class="se">      \</span>   <span class="k">call</span> <span class="nv">s:ConvertBinaryPlist</span><span class="p">()</span> <span class="p">|</span>
<span class="se">      \</span> <span class="k">endif</span>
</code></pre></div></div><p>The <code class="highlighter-rouge">getline(1)</code> reads the first line of the buffer, and we can call it because it’s after reading the file. It’s working quite well, so at that time, I wanted to bring the writing functionality also.</p><div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span><span class="p">!</span> <span class="nv">s:ConvertBinaryPlist</span><span class="p">()</span>
  <span class="k">silent</span><span class="p">!</span> execute <span class="s1">'%d'</span>
  <span class="k">call</span> plist#Read<span class="p">(</span><span class="m">1</span><span class="p">)</span>
  <span class="k">call</span> plist#ReadPost<span class="p">()</span>

  autocmd<span class="p">!</span> <span class="nb">BufWriteCmd</span><span class="p">,</span><span class="nb">FileWriteCmd</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span>
  autocmd <span class="nb">BufWriteCmd</span><span class="p">,</span><span class="nb">FileWriteCmd</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span>
<span class="se">        \</span> <span class="k">call</span> plist#Write<span class="p">()</span>
<span class="k">endfunction</span>
</code></pre></div></div><p>Note that the <code class="highlighter-rouge">autocmd!</code> line means deleting every other <code class="highlighter-rouge">BufWriteCmd</code> and <code class="highlighter-rouge">FileWriteCmd</code> autocmds for that buffer, and the second line registers <code class="highlighter-rouge">BufWriteCmd</code> and <code class="highlighter-rouge">FileWriteCmd</code> for that buffer.</p><p>But when I saved after editing a *.strings file, I saw this error message:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;stdin&gt;: Property List error: Unable to convert string to correct encoding / JSON error: JSON text did not start with array or object and option to allow fragments not set.
</code></pre></div></div><p>After poking around, I found that the <code class="highlighter-rouge">fileencoding</code> is set to <code class="highlighter-rouge">latin1</code>. The original file is binary and we just replaced the contents of the buffer, the <code class="highlighter-rouge">fileencoding</code> was not properly set. So I just set it to UTF-8.</p><div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span><span class="p">!</span> <span class="nv">s:ConvertBinaryPlist</span><span class="p">()</span>
  <span class="k">silent</span><span class="p">!</span> execute <span class="s1">'%d'</span>
  <span class="k">call</span> plist#Read<span class="p">(</span><span class="m">1</span><span class="p">)</span>
  <span class="k">call</span> plist#ReadPost<span class="p">()</span>
  <span class="k">set</span> fileencoding<span class="p">=</span>utf<span class="m">-8</span>

  autocmd<span class="p">!</span> <span class="nb">BufWriteCmd</span><span class="p">,</span><span class="nb">FileWriteCmd</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span>
  autocmd <span class="nb">BufWriteCmd</span><span class="p">,</span><span class="nb">FileWriteCmd</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span>
<span class="se">        \</span> <span class="k">call</span> plist#Write<span class="p">()</span>
<span class="k">endfunction</span>
</code></pre></div></div><h3>Saving a new file</h3><p>It’s simple:</p><div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>autocmd <span class="nb">BufNewFile</span> *<span class="p">.</span>plist
<span class="se">      \</span> <span class="k">if</span> <span class="p">!</span>get<span class="p">(</span><span class="k">b</span><span class="p">:,</span> <span class="s1">'plist_original_format'</span><span class="p">)</span> <span class="p">|</span>
<span class="se">      \</span>   <span class="k">let</span> <span class="nv">b:plist_original_format</span> <span class="p">=</span> <span class="s1">'xml'</span> <span class="p">|</span>
<span class="se">      \</span> <span class="k">endif</span>
</code></pre></div></div><p>We don’t write binary file by our own hands, so a new plist file would be in xml format.</p><h3>Disable <code class="highlighter-rouge">autocmd</code>s of vim-plist (Update: 2019-06-18)</h3><p>I decided to remove default <code class="highlighter-rouge">autocmd</code>s of vim-plist. The plist files I open or edit are either in XML format or binary format. When the file is in binary format, it’s handled by above vimrc. When the file is in XML format, it doesn’t need to be converted as I’ll save them in the same format.</p><div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">g:loaded_plist</span> <span class="p">=</span> <span class="m">1</span>
<span class="k">let</span> <span class="nv">g:plist_display_format</span> <span class="p">=</span> <span class="s1">'xml'</span>
<span class="k">let</span> <span class="nv">g:plist_save_format</span> <span class="p">=</span> <span class="s1">''</span>
<span class="k">let</span> <span class="nv">g:plist_json_filetype</span> <span class="p">=</span> <span class="s1">'json'</span>
</code></pre></div></div><p>When <code class="highlighter-rouge">g:loaded_plist</code> exists, vim-plist will do nothing. In <a href="https://github.com/darfink/vim-plist/blob/master/plugin/plist.vim">plugin/plist.vim</a>, it registers <code class="highlighter-rouge">autocmd</code>s and set default values to global variables. So here we set global variables of vim-plist. The default value of <code class="highlighter-rouge">g:plist_json_filetype</code> is <code class="highlighter-rouge">'javascript'</code>, but I set it to <code class="highlighter-rouge">'json'</code> as Vim can handle that filetype.</p><h2>Conclusion</h2><p>So this is the complete part of my .vimrc for binary plist files:</p><div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span><span class="p">!</span> <span class="nv">s:ConvertBinaryPlist</span><span class="p">()</span>
  <span class="k">silent</span><span class="p">!</span> execute <span class="s1">'%d'</span>
  <span class="k">call</span> plist#Read<span class="p">(</span><span class="m">1</span><span class="p">)</span>
  <span class="k">call</span> plist#ReadPost<span class="p">()</span>
  <span class="k">set</span> fileencoding<span class="p">=</span>utf<span class="m">-8</span>

  augroup BinaryPlistWrite
    autocmd<span class="p">!</span> <span class="nb">BufWriteCmd</span><span class="p">,</span><span class="nb">FileWriteCmd</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span>
    autocmd <span class="nb">BufWriteCmd</span><span class="p">,</span><span class="nb">FileWriteCmd</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">call</span> plist#Write<span class="p">()</span>
  augroup END
<span class="k">endfunction</span>
augroup BinaryPlistRead
  autocmd<span class="p">!</span>
  autocmd <span class="nb">BufRead</span> *
<span class="se">        \</span> <span class="k">if</span> getline<span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="p">=~</span># <span class="s1">'^bplist'</span> <span class="p">|</span>
<span class="se">        \</span>   <span class="k">call</span> <span class="nv">s:ConvertBinaryPlist</span><span class="p">()</span> <span class="p">|</span>
<span class="se">        \</span> <span class="k">endif</span>
  autocmd <span class="nb">BufNewFile</span> *<span class="p">.</span>plist
<span class="se">        \</span> <span class="k">if</span> <span class="p">!</span>get<span class="p">(</span><span class="k">b</span><span class="p">:,</span> <span class="s1">'plist_original_format'</span><span class="p">)</span> <span class="p">|</span>
<span class="se">        \</span>   <span class="k">let</span> <span class="nv">b:plist_original_format</span> <span class="p">=</span> <span class="s1">'xml'</span> <span class="p">|</span>
<span class="se">        \</span> <span class="k">endif</span>
augroup END
<span class="c">" Disable default autocmds</span>
<span class="k">let</span> <span class="nv">g:loaded_plist</span> <span class="p">=</span> <span class="m">1</span>
<span class="k">let</span> <span class="nv">g:plist_display_format</span> <span class="p">=</span> <span class="s1">'xml'</span>
<span class="k">let</span> <span class="nv">g:plist_save_format</span> <span class="p">=</span> <span class="s1">''</span>
<span class="k">let</span> <span class="nv">g:plist_json_filetype</span> <span class="p">=</span> <span class="s1">'json'</span>
</code></pre></div></div><p>It’s also available on <a href="https://github.com/yous/dotfiles/blob/0d95f7a13f70fe755ff9d1e35b64a42bcbf99973/vimrc#L1684-L1711">GitHub</a>, you can visit my <a href="https://github.com/yous/dotfiles">dotfiles</a> repository!</p></div><li><header class="post-header"><h1 class="post-title"> <a class="post-link" href="/2017/11/14/how-to-make-a-bootable-usb-with-grub2-and-iso/">How to make a bootable USB with GRUB2 and ISO</a></h1><p class="post-meta"> Nov 14, 2017 • <a href="/categories/linux/">Linux</a></p></header><div class="post-content"><p>Do you have multiple ISO files to install, with quite enough storage of USB stick? You’ll want to install all of them with a single USB stick. Here’s how.</p><h2>Formatting USB disk</h2><p>First, plug in your USB stick and find it from your Linux machine:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>fdisk <span class="nt">-l</span>
Disk /dev/sda: 20 GiB, 21474836480 bytes, 41943040 sectors
Units: sectors of 1 <span class="k">*</span> 512 <span class="o">=</span> 512 bytes
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: 512 bytes / 512 bytes
I/O size <span class="o">(</span>minimum/optimal<span class="o">)</span>: 512 bytes / 512 bytes
Disklabel <span class="nb">type</span>: dos
Disk identifier: 0x4d149927

Device     Boot    Start      End  Sectors  Size Id Type
/dev/sda1  <span class="k">*</span>        2048 39845887 39843840   19G 83 Linux
/dev/sda2       39847934 41940991  2093058 1022M  5 Extended
/dev/sda5       39847936 41940991  2093056 1022M 82 Linux swap / Solaris


Disk /dev/sdb: 14.6 GiB, 15664676864 bytes, 30595072 sectors
Units: sectors of 1 <span class="k">*</span> 512 <span class="o">=</span> 512 bytes
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: 512 bytes / 512 bytes
I/O size <span class="o">(</span>minimum/optimal<span class="o">)</span>: 512 bytes / 512 bytes
Disklabel <span class="nb">type</span>: gpt
Disk identifier: 4788154A-7BD2-4A06-945B-5980E828C8C5

Device      Start      End  Sectors  Size Type
/dev/sdb1      40   409639   409600  200M EFI System
/dev/sdb2  411648 30593023 30181376 14.4G Microsoft basic data
</code></pre></div></div><p>In my case, it’s <code class="highlighter-rouge">/dev/sdb</code>. Let’s format it with <code class="highlighter-rouge">fdisk</code>. When you run <code class="highlighter-rouge">fdisk /dev/sdb</code>, you can print help menu:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>fdisk /dev/sdb

Welcome to fdisk <span class="o">(</span>util-linux 2.27.1<span class="o">)</span><span class="nb">.</span>
Changes will remain <span class="k">in </span>memory only, <span class="k">until </span>you decide to write them.
Be careful before using the write command.


Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: m

Help:

  Generic
   d   delete a partition
   F   list free unpartitioned space
   l   list known partition types
   n   add a new partition
   p   print the partition table
   t   change a partition <span class="nb">type
   </span>v   verify the partition table
   i   print information about a partition

  Misc
   m   print this menu
   x   extra functionality <span class="o">(</span>experts only<span class="o">)</span>

  Script
   I   load disk layout from sfdisk script file
   O   dump disk layout to sfdisk script file

  Save &amp; Exit
   w   write table to disk and <span class="nb">exit
   </span>q   quit without saving changes

  Create a new label
   g   create a new empty GPT partition table
   G   create a new empty SGI <span class="o">(</span>IRIX<span class="o">)</span> partition table
   o   create a new empty DOS partition table
   s   create a new empty Sun partition table
</code></pre></div></div><p>Now we can start!</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>fdisk /dev/sdb

Welcome to fdisk <span class="o">(</span>util-linux 2.27.1<span class="o">)</span><span class="nb">.</span>
Changes will remain <span class="k">in </span>memory only, <span class="k">until </span>you decide to write them.
Be careful before using the write command.


Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: o
Created a new DOS disklabel with disk identifier 0x8c9faeb0.

Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: n
Partition <span class="nb">type
   </span>p   primary <span class="o">(</span>0 primary, 0 extended, 4 free<span class="o">)</span>
   e   extended <span class="o">(</span>container <span class="k">for </span>logical partitions<span class="o">)</span>
Select <span class="o">(</span>default p<span class="o">)</span>:

Using default response p.
Partition number <span class="o">(</span>1-4, default 1<span class="o">)</span>:
First sector <span class="o">(</span>2048-30595071, default 2048<span class="o">)</span>:
Last sector, +sectors or +size<span class="o">{</span>K,M,G,T,P<span class="o">}</span> <span class="o">(</span>2048-30595071, default 30595071<span class="o">)</span>:

Created a new partition 1 of <span class="nb">type</span> <span class="s1">'Linux'</span> and of size 14.6 GiB.

Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: t
Selected partition 1
Partition <span class="nb">type</span> <span class="o">(</span><span class="nb">type </span>L to list all types<span class="o">)</span>: c
Changed <span class="nb">type </span>of partition <span class="s1">'Linux'</span> to <span class="s1">'W95 FAT32 (LBA)'</span><span class="nb">.</span>

Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: a
Selected partition 1
The bootable flag on partition 1 is enabled now.

Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: w
The partition table has been altered.
Calling ioctl<span class="o">()</span> to re-read partition table.
Syncing disks.
</code></pre></div></div><p>We’ve just created one bootable FAT partition, and that’ll be <code class="highlighter-rouge">/dev/sdb1</code>. Let’s create an MS-DOS filesystem in it. This will take a while.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>mkfs.vfat <span class="nt">-F</span> 32 /dev/sdb1
mkfs.fat 3.0.28 <span class="o">(</span>2015-05-16<span class="o">)</span>
</code></pre></div></div><p>Now you can mount that partition and we’re ready to install GRUB2 in it.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mkdir</span> /mnt/usb
<span class="nb">sudo </span>mount /dev/sdb1 /mnt/usb
</code></pre></div></div><h2>Installing GRUB2</h2><p>Since we’re installing GRUB2 into USB stick, we specify <code class="highlighter-rouge">--removable</code> flag. Also specify <code class="highlighter-rouge">--boot-directory</code> so that GRUB2 is installed to there instead of <code class="highlighter-rouge">/boot/grub</code>.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>grub-install <span class="nt">--removable</span> <span class="nt">--boot-directory</span><span class="o">=</span>/mnt/usb/boot /dev/sdb
Installing <span class="k">for </span>i386-pc platform.
Installation finished. No error reported.
</code></pre></div></div><p>We’ll add <code class="highlighter-rouge">grub.cfg</code> file under <code class="highlighter-rouge">/mnt/usb/boot/grub/</code> directory. It defines selectable menus and the booting method of each entry. This time I’ll add Ubuntu Desktop ISO for i386 platform.</p><pre><code class="language-grub">set timeout=5
set default=0

menuentry "Ubuntu Desktop 16.04.3 LTS i386" {
  set isofile="/iso/ubuntu-16.04.3-desktop-i386.iso"
  loopback loop $isofile
  linux (loop)/casper/vmlinuz boot=casper file=/preseed/ubuntu.seed iso-scan/filename=$isofile noeject noprompt splash --
  initrd (loop)/casper/initrd.lz
}

menuentry "Ubuntu Desktop 16.04.3 LTS amd64" {
  set isofile="/iso/ubuntu-16.04.3-desktop-amd64.iso"
  loopback loop $isofile
  linux (loop)/casper/vmlinuz.efi boot=casper file=/preseed/ubuntu.seed iso-scan/filename=$isofile noeject noprompt splash --
  initrd (loop)/casper/initrd.lz
}

menuentry "Ubuntu Server 16.04.3 LTS i386" {
  set isofile="/iso/ubuntu-16.04.3-server-i386.iso"
  loopback loop $isofile
  linux (loop)/install/vmlinuz boot=casper file=/preseed/ubuntu-server.seed iso-scan/filename=$isofile noeject noprompt splash --
  initrd (loop)/install/initrd.gz
}

menuentry "Ubuntu Server 16.04.3 LTS amd64" {
  set isofile="/iso/ubuntu-16.04.3-server-amd64.iso"
  loopback loop $isofile
  linux (loop)/install/vmlinuz boot=casper file=/preseed/ubuntu-server.seed iso-scan/filename=$isofile noeject noprompt splash --
  initrd (loop)/install/initrd.gz
}

menuentry "Linux Mint 18.2 Cinnamon 32-bit" {
  set isofile="/iso/linuxmint-18.2-cinnamon-32bit.iso"
  loopback loop $isofile
  linux (loop)/casper/vmlinuz boot=casper file=/preseed/linuxmint.seed iso-scan/filename=$isofile noeject noprompt splash --
  initrd (loop)/casper/initrd.lz
}

menuentry "Custom ELF" {
  elffile="/elf/custom.elf"
  multiboot $elffile
}
</code></pre><p>In the first menuentry, <code class="highlighter-rouge">isofile</code> points to <code class="highlighter-rouge">/iso/ubuntu-16.04.3-desktop-i386.iso</code>, and it’s relative path of the USB stick. Create <code class="highlighter-rouge">/mnt/usb/iso/</code> directory, and put the ISO files under there.</p><p>You may need to look inside of ISO file to find where is <code class="highlighter-rouge">vmlinuz*</code> and <code class="highlighter-rouge">initrd.*</code> files. Try this:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>isoinfo <span class="nt">-l</span> <span class="nt">-i</span> myimage.iso
</code></pre></div></div><p>As the similar way, you can also make it to boot from ELF file. Just put the ELF file that supports <a href="https://www.gnu.org/software/grub/manual/multiboot/multiboot.html">Multiboot</a> under <code class="highlighter-rouge">/mnt/usb/elf/</code> directory, and edit the menuentry properly.</p><p>After editing is done, unmount the disk and use it right away!</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>umount /dev/sdb1
</code></pre></div></div><h2>Troubleshooting</h2><p>If your screen goes black on boot, try with <code class="highlighter-rouge">nomodeset</code>:</p><pre><code class="language-grub">linux ... noeject noprompt splash nomodeset --
</code></pre><h2>See also</h2><ul><li><a href="https://help.ubuntu.com/community/Grub2/ISOBoot/Examples">Grub2/ISOBoot/Examples</a><li><a href="http://manpages.ubuntu.com/manpages/xenial/man7/casper.7.html">Ubuntu Manpage: casper</a></ul></div><li><header class="post-header"><h1 class="post-title"> <a class="post-link" href="/2017/03/07/pushing-git-repository-to-multiple-remotes/">Pushing git repository to multiple remotes</a></h1><p class="post-meta"> Mar 7, 2017 • <a href="/categories/git/">Git</a></p></header><div class="post-content"><p>I’m currently managing my dotfiles repository on both of <a href="https://github.com/yous/dotfiles">GitHub</a> and <a href="https://bitbucket.org/yous/dotfiles">Bitbucket</a>. These two repositories are the same, but I don’t want to remove one of them. I mainly use GitHub for hosting code now, but the first place I uploaded my dotfiles to was Bitbucket.</p><p>I want to keep the HEAD of two remote repositories be the same, so when I push code to my dotfiles, the both of them must be updated at the same time.</p><h2>Default git config</h2><p>First, clone or init the repository.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/yous/dotfiles.git
</code></pre></div></div><p>Then, as you know, the origin will be set to <code class="highlighter-rouge">https://github.com/yous/dotfiles.git</code>. This is the content of <code class="highlighter-rouge">.git/config</code>:</p><pre><code class="language-gitconfig">[core]
	# ...
[remote "origin"]
	url = https://github.com/yous/dotfiles.git
	fetch = +refs/heads/*:refs/remotes/origin/*
[branch "master"]
	# ...
</code></pre><p>Note that there is the <code class="highlighter-rouge">url</code> attribute under <code class="highlighter-rouge">remote "origin"</code>.</p><h2>git remote set-url</h2><p>Now we’re going to run <code class="highlighter-rouge">git remote set-url</code> twice so that the repository will have two push remote URLs. Setting <em>push</em> remote URL is slightly different from plaing <code class="highlighter-rouge">git remote set-url &lt;name&gt; &lt;newurl&gt;</code>. See <code class="highlighter-rouge">man git-remote</code>:</p><pre><code class="language-man">set-url
    Changes URLs for the remote. Sets first URL for remote &lt;name&gt; that
    matches regex &lt;oldurl&gt; (first URL if no &lt;oldurl&gt; is given) to
    &lt;newurl&gt;. If &lt;oldurl&gt; doesn't match any URL, an error occurs and
    nothing is changed.

    With --push, push URLs are manipulated instead of fetch URLs.

    With --add, instead of changing existing URLs, new URL is added.
</code></pre><p>So we need to run <code class="highlighter-rouge">git remote set-url --push &lt;name&gt; &lt;newurl&gt;</code>. Moreover, we need two push URL, so the second command should be <code class="highlighter-rouge">git remote set-url --add --push &lt;name&gt; &lt;newurl&gt;</code>. It’s okay to specify <code class="highlighter-rouge">--add --push</code> to the first command, too.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git remote set-url <span class="nt">--add</span> <span class="nt">--push</span> origin https://github.com/yous/dotfiles.git
git remote set-url <span class="nt">--add</span> <span class="nt">--push</span> origin https://bitbucket.org/yous/dotfiles.git
</code></pre></div></div><p>Now, the content of <code class="highlighter-rouge">.git/config</code> would be like this:</p><pre><code class="language-gitconfig">[core]
	# ...
[remote "origin"]
	url = https://github.com/yous/dotfiles.git
	fetch = +refs/heads/*:refs/remotes/origin/*
	pushurl = https://github.com/yous/dotfiles.git
	pushurl = https://bitbucket.org/yous/dotfiles.git
[branch "master"]
	# ...
</code></pre><p>All done! Note that there are two <code class="highlighter-rouge">pushurl</code>s under <code class="highlighter-rouge">remote "origin"</code>. Now <code class="highlighter-rouge">git push</code> automatically pushes to the both push remote URLs.</p></div><li><header class="post-header"><h1 class="post-title"> <a class="post-link" href="/2017/03/01/boston-key-party-ctf-2017-vimjail-write-up/">Boston Key Party CTF 2017: vimjail write-up</a></h1><p class="post-meta"> Mar 1, 2017 • <a href="/categories/ctf/">CTF</a></p></header><div class="post-content"><h2>vimjail (pwn 150)</h2><blockquote><ul><li><code class="highlighter-rouge">ssh ctfuser@ec2-54-200-176-5.us-west-2.compute.amazonaws.com</code><li>password: <code class="highlighter-rouge">loginPWforVimJail</code></ul><p>Can you read the flag?</p><p><em>UPDATES</em></p><ul><li>(13:38 UTC Saturday): The flag is not in <code class="highlighter-rouge">/tmp</code>.<li>(13:31 EST Saturday): new ip</ul></blockquote><h2>Looking around</h2><p>Well, you would do <code class="highlighter-rouge">ls</code> first when you logged in, so do we. And there was <code class="highlighter-rouge">~/flagReader</code>.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ctfuser@ip-172-31-31-196:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-als</span> /home/ctfuser/flagReader
12 <span class="nt">---S--x---</span> 1 topsecretuser secretuser 8768 Feb 25 08:42 /home/ctfuser/flagReader
</code></pre></div></div><p>If you try completion by pressing Tab key or try to move around using <code class="highlighter-rouge">cd</code>, it fails with an error message from rbash. It’s restricted bash, but you can simply run <code class="highlighter-rouge">bash</code> to escape.</p><p>While moving around, we found nothing special without <code class="highlighter-rouge">/.flag</code>. Also there were some <code class="highlighter-rouge">.s[a-z][a-z]</code> files under <code class="highlighter-rouge">/var/tmp/</code> and <code class="highlighter-rouge">/tmp/</code>, created by <code class="highlighter-rouge">secretuser</code>. But there are not in fixed location when the problem server was changed, so we thought there would be a way to run Vim under <code class="highlighter-rouge">secretuser</code>’s permission.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ctfuser@ip-172-31-31-196:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-als</span> /.flag
4 <span class="nt">-r--------</span> 1 topsecretuser topsecretuser 39 Feb 25 08:42 /.flag
</code></pre></div></div><p>We also tried to find setuid or setgid files, but there was only the previous <code class="highlighter-rouge">flagReader</code>.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ctfuser@ip-172-31-31-196:/tmp<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-4000</span> <span class="nt">-o</span> <span class="nt">-perm</span> <span class="nt">-2000</span> <span class="nt">-type</span> f 2&gt;/dev/null
/bin/ping
/bin/ping6
/bin/fusermount
/bin/umount
/bin/su
/bin/mount
/bin/ntfs-3g
/sbin/unix_chkpwd
/sbin/pam_extrausers_chkpwd
/usr/lib/x86_64-linux-gnu/utempter/utempter
/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
/usr/lib/openssh/ssh-keysign
/usr/lib/snapd/snap-confine
/usr/lib/eject/dmcrypt-get-device
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/bin/crontab
/usr/bin/newuidmap
/usr/bin/at
/usr/bin/chage
/usr/bin/sudo
/usr/bin/bsd-write
/usr/bin/pkexec
/usr/bin/chfn
/usr/bin/expiry
/usr/bin/newgrp
/usr/bin/screen
/usr/bin/chsh
/usr/bin/gpasswd
/usr/bin/newgidmap
/usr/bin/ssh-agent
/usr/bin/passwd
/usr/bin/mlocate
/home/ctfuser/flagReader
</code></pre></div></div></div><p class="post-continue"> <a href="/2017/03/01/boston-key-party-ctf-2017-vimjail-write-up/">Read on &rarr;</a></p></ul><div class="pagination"> <a class="previous" href="/posts/2/">&laquo; Older</a></div></div></div></main><footer class="site-footer"><div class="wrapper"><p> Content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a><br /> &copy; 2013&ndash;2019 - <a href="/about/">Yous</a> - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="https://yous.be/atom.xml">RSS</a></p></div></footer>
